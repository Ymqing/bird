<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<canvas width="800" height="600" id="cvs" style="border:1px solid red;"></canvas>
<script src="js/util.js"></script>
<script src="js/getImgObj.js"></script>
<script src="js/bird.js"></script>
<script src="js/sky.js"></script>
<script src="js/land.js"></script>
<script src="js/pipe.js"></script>
<script>

    // 游戏主模块
    (function () {

        var cvs = document.getElementById('cvs');
        var ctx = cvs.getContext('2d');

        // 获取游戏所需要的图像对象
        getImgObj(function (imgObj) {

            // 必须先初始化Bird类(把绘图环境和bird图像资源传进入，供对方使用)
            Bird.init(ctx, imgObj.bird);
            var bird = new Bird(10, 10, 52, 45);

            cvs.addEventListener('click', function () {
                // 改变小鸟下落为飞翔
                bird.speed = -2;
            });

            // 创建背景天空
            Sky.init(ctx, imgObj.sky);
            var sky = new Sky();
            var sky2 = new Sky(800);

            // 创建大地
            Land.init(ctx, imgObj.land);
            var land = new Land(0, cvs.height - imgObj.land.height);
            var land2 = new Land(imgObj.land.width * 1, cvs.height - imgObj.land.height);
            var land3 = new Land(imgObj.land.width * 2, cvs.height - imgObj.land.height);
            var land4 = new Land(imgObj.land.width * 3, cvs.height - imgObj.land.height);

            // 创建管道
            Pipe.init(ctx, imgObj.pipeDown, imgObj.pipeUp);
            var pipe = new Pipe(300, 0);
            var pipe2 = new Pipe(300 + imgObj.pipeDown.width * 3 * 1, 0);
            var pipe3 = new Pipe(300 + imgObj.pipeDown.width * 3 * 2, 0);
            var pipe4 = new Pipe(300 + imgObj.pipeDown.width * 3 * 3, 0);
            var pipe5 = new Pipe(300 + imgObj.pipeDown.width * 3 * 4, 0);
            var pipe6 = new Pipe(300 + imgObj.pipeDown.width * 3 * 5, 0);

            var timer = setInterval(function () {

                // 小鸟的中心点坐标
                var birdCoreX = bird.x + bird.w / 2;
                var birdCoreY = bird.y + bird.h / 2;

                // 小鸟碰撞检测，如果碰撞那么就停止渲染游戏画面
                if (
                    // 检测小鸟的中心点有没有飞出上面的画布
                    birdCoreY <= 0 ||
                    // 检测小鸟的中心点有没有撞向大地
                    birdCoreY >= cvs.height - imgObj.land.height ||
                    // 检测小鸟的中心点有没有和管道碰撞
                    ctx.isPointInPath(birdCoreX, birdCoreY)
                ) {
                    clearInterval(timer);
                    return;
                }

                // 清除画布
                ctx.clearRect(0, 0, cvs.width, cvs.height);

                sky.draw();
                sky.update();

                sky2.draw();
                sky2.update();

                ctx.beginPath();
                pipe.draw();
                pipe.update();
                pipe2.draw();
                pipe2.update();
                pipe3.draw();
                pipe3.update();
                pipe4.draw();
                pipe4.update();
                pipe5.draw();
                pipe5.update();
                pipe6.draw();
                pipe6.update();

                land.draw();
                land.update();
                land2.draw();
                land2.update();
                land3.draw();
                land3.update();
                land4.draw();
                land4.update();

                bird.draw();
                bird.update();

            }, 1000 / 60);
        });
    }());
</script>
</body>
</html>
